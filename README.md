# peripheral_dev_tst

# Table of Contents
* [the Devices](#the-Devices)
	* [AT30TSE752](#AT30TSE752)
	* [HTS221 ](#HTS221-)
	* [MCP23009 ](#MCP23009-)
	* [MCP4725 ](#MCP4725-)
	* [MCP4728_tst](#MCP4728_tst)
* [MBED ](#MBED-)
	* [preparations : ](#preparations-:-)
	* [generating the programing files ](#generating-the-programing-files-)
* [dummy  Linux ](#dummy--Linux-)
* [raspberry PI ](#raspberry-PI-)


(TOC generated by https://pypi.org/project/markdown-toc/#Usage )

## Introduction

Test program for the  i2c devices in PerDevices repository <br>

In the chapter MBED and dummy Linux it is explained how to install the code for the corresponding platform. 


For most of the devices I have a PCB design. Let me know if you are interested. 

A number of these devices are used in one or more experiments of test setups.<br> 
By example the SOLID experiment : http://solid-experiment.org/ 

All the devices use a pointer to an abstract I2C class so it easy to reuse. 

In general I try to give references to code I copied or that I used as base for the development of the code.  But in the heat of getting it ready sometimes I copied code without keeping track where I got it from.  So in case you think you are the original author of some code please let me know. ( via github) . 

### the getVersion class

All the code inherit a getVersion class.  With this class you cab get the version  and compile time. I use this in the projects at the start as printout . This helps to trace back why a "update"  is not working . As the code is used in several projects sometimes a change is  not backwards compatible. 

## the Devices
Below a short description of the devices. <br>
Most devices are tested with the  FRDM-KL05Z or FRDM-KL25Z  ( MBED ) platform. 

Please check the date of the last commit of this file. <br>
The links to the data info from the manufactures could be outdated ( my experience is the manufactures change  their websites almost every year or the merge with others ) 

### ADC101_xx
 
10 bits ADC  189kSPS  1 CH  <br>
This is for a whole series of ADC's from Texas Instruments.  <br>
It is only tested with adc101c021  .  <br>
http://www.ti.com/product/ADC101C021

### AT30TSE752

This is a cheap temperature sensor with eeprom with a wide voltage range.  <br>
I used the eeprom by example to store calibration values and device ID's . <br>
When I used them ( > 300)  for the SOLID experiment it was still Atmel.  Now it is taken over by Micro chip  <br>
The AT30TSE752 is obsolete but the AT30TSE752A is still available. I used both   <br>
I have problems with locking and /or unlocking the eeprom contents.  It sometimes fails and seems not recoverable ( so if locked , you can not unlock it anymore) 


### HTS221 

A humidity and temperature sensor from st  ( st.com ) <br>
https://www.st.com/content/st_com/en/products/mems-and-sensors/humidity-sensors/hts221.html

For the price it is a good sensor , we use it in the SOLID experiment to monitor humidity and temperatures on several places.  <br>
Pitty the package can not (at all ?) soldered manual. But as we used many of this I had to make a small PCB.  

### MCP23009 

I2C IO extender . 5.5 V tolerant  <br>
Micro chip .  <br>
https://www.microchip.com/wwwproducts/en/MCP23009

Not sure I used this device.

### MCP4725 

DAC  12 bits resolution  1 channel  On-Board Non-Volatile Memory (EEPROM)   <br>
The EEPROM is very useful to get a working starting point for a device without any software needed.  <br>
web site (micro chip ) <br>
https://www.microchip.com/wwwproducts/en/en532229

### MCP4728_tst

DAC 28 bits  4 channels,  On-Board Non-Volatile Memory (EEPROM)  <br>
https://www.microchip.com/wwwproducts/en/en541737
 
The address can be set by programming.  For the MBED on-line compiler this is supported but not (yet) for this version as also IO pins and interrupt are needed.
if you want to program the I2C address check this  project<br>
https://os.mbed.com/users/wbeaumont/code/MCP4728test/

Be sure you select the correct pins for the IO.  




## MBED 

These are simple test programs  for the devices in the repository https://github.com/wimbeaumont/PerDevices

This repository contains classes for the I2C devices and I2C abstraction classes. 

To generate the files to download to the device the   mbed-cli is used <br>. 
MBED os  5.12  ( the latest at this moment)  As I use python 3  older MBED version ( < 5.x )  are not supported  

Assumed is that the \_\_MBED\_\_ variable is set. This is used to include / define MBED specific code 


### preparations : 

Worked on windows 7

   * git was already installed 
   * Installed python3  
   * installed mercurial 
   * run Mbed_installer_v0.4.10.exe   (mbed-cli ) 

Below the description to handle multi projects ( as each test is a project) 

C:\Users\SomeUser\My Documents\mbed_cli   is the projdir<br>
( the location of the project directory is not important as long you have all the access rights) 

in the projdir git clone 

git clone https://github.com/wimbeaumont/PeripheralDevices.git
   
git clone https://github.com/wimbeaumont/peripheral_dev_tst.git

In the projdir  :   mbed import mbed-os
  
set the globals  
mbed config -G MBED_OS_DIR mbed-os
 
So the .mbed is now 
( this is in the users home directory so  C:\Users\SomeUser\\.mbed ) 
 
---
 
GCC_ARM_PATH=C:\Program Files (x86)\GNU Tools ARM Embedded\6 2017-q2-update\bin <br>
TOOLCHAIN=GCC_ARM<br>
ARM_PATH=C:\Program Files (x86)\GNU Tools ARM Embedded\6 2017-q2-update\bin<br>
MBED_OS_DIR=C:\Users\wimb\My Documents\mbed_cli\mbed-os<br>

--- 

### generating the programming files 

now  prepare the mbed project 

cd peripheral_dev_tst 

C:\Users\SomeUser\My Documents\mbed_cli\peripheral_dev_tst>mbed new ADC101_xx_tst -scm none 

(is  mbed new  really needed ?  the --scm none is to avoid the .git is overwritten ) 

**now compile for MBED**

in projdir

mbed compile -m KL25Z --source peripheral_dev_tst/ADC101_xx_tst --source PeripheralDevices --source mbed-os --build BUILD/ADC101_xx_tst<br>
not tested with the ADC101  but the KL25Z responds correctly 

mbed compile -m KL25Z --source peripheral_dev_tst/MCP4725_tst --source PeripheralDevices --source mbed-os --build BUILD/MCP4725_tst<br>
not tested with the MCP4725  but the KL25Z responds 

As you notice in the last case the is not made a new mbed project. So not so clear if you have to do it at all as with the paramters and global settings you almost define all needed. 


in the same way :  (most not verified  on the target ) 

mbed compile -m KL25Z --source peripheral_dev_tst/HTS221_tst --source PeripheralDevices --source mbed-os --build BUILD/HTS221_tst

mbed compile -m KL25Z --source peripheral_dev_tst/AT30TSE752_tst --source PeripheralDevices --source mbed-os --build BUILD/AT30TSE752_tst

mbed compile -m KL25Z --source peripheral_dev_tst/MCP4728_tst --source PeripheralDevices --source mbed-os --build BUILD/MCP4728_tst

mbed compile -m KL25Z --source peripheral_dev_tst/MCP23009_tst --source PeripheralDevices --source mbed-os --build BUILD/MCP23009_tst

This method will most likely not work for the FRDM-KL05Z as this device is not supported for mbed os > 2.x 
Perhaps it works when using python 2.7 

for more info this is a nice page: 

https://os.mbed.com/docs/mbed-os/v5.12/tools/working-with-mbed-cli.html

## dummy  Linux 

This is a version to compile / develop with a full develop system ( standard linux desktop environment) <br> 
Tested with CentOs  7

Uses cmake to generate the test programs

go to the cmake directory<br>
there  $>cmake . <br>
then  $>make  <br> 







## raspberry PI 

Tried the dummy Linux on the Pi  was working (had to install cmake ) 

try to understand which I2C interface I have to use.  Most likely  i2c-dev   but not clear how to generate a single start or stop command. 


